<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SSD: Signle Shot Detector 用于自然场景文字检测</title>
<link rel="stylesheet" href="https://chenxinpeng.github.io/assets/css/jemdoc.css", type="text/css" />
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body><div class="container"><h2 id="前言">前言</h2>

<p>之前我在 <a href="http://blog.csdn.net/u010167269/article/details/52563573">论文阅读：SSD: Single Shot MultiBox Detector</a> 中，讲了这个最新的 Object Detection 算法。</p>

<p>既然 SSD 是用来检测物体的，那么可不可以将 SSD 用来检测自然场景图像中的文字呢？答案肯定是可以的～</p>

<p>同时，受到浙大 <a href="http://weibo.com/u/5745235949?is_all=1">solace_hyh</a> 同学的 <a href="https://github.com/hyh21521038/ssd-plate_detection">ssd-plate_detection</a> 工作，这篇文章记录我自己将 SSD 用于文字检测的过程。</p>

<p>全部的代码上传到 Github 了：<a href="https://github.com/chenxinpeng/SSD_scene-text-detection">https://github.com/chenxinpeng/SSD_scene-text-detection</a>，<font color="blue">代码质量不太高，还请高手指点</font> 。^_^</p>

<p><br></p>



<h2 id="准备与转换数据集">准备与转换数据集</h2>

<p><a href="http://robustreading.opendfki.de/trac/wiki/SceneText">ICDAR 2011</a> 数据集训练集共有 229 张图像，我将其分为 159 张、70张图像两部分。前者用作训练，后者用于训练时进行测试。</p>

<p>下面就是要将这些图像，转换成 lmdb 格式，用于 caffe 训练；将文字区域的标签，转换为 Pascal VOC 的 XML 格式。</p>



<h3 id="将-ground-truth-转换为-pascal-voc-xml-文件">将 ground truth 转换为 Pascal VOC XML 文件</h3>

<p>先将 ICDAR 2011 给定的 <code>gt_**.txt</code> 标签文件转换为 Pascal VOC XML 格式。</p>

<p>先看下原来的 <code>gt_**.txt</code> 格式，如下图，有一张原始图像：</p>

<p></p><center><img src="http://img.blog.csdn.net/20161018191755187" height="250"></center><p></p>

<p>下面是其 ground truth 文件：</p>



<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-number">158</span>,<span class="hljs-number">128</span>,<span class="hljs-number">412</span>,<span class="hljs-number">182</span>,<span class="hljs-string">"Footpath"</span>
<span class="hljs-number">442</span>,<span class="hljs-number">128</span>,<span class="hljs-number">501</span>,<span class="hljs-number">170</span>,<span class="hljs-string">"To"</span>
<span class="hljs-number">393</span>,<span class="hljs-number">198</span>,<span class="hljs-number">488</span>,<span class="hljs-number">240</span>,<span class="hljs-string">"and"</span>
<span class="hljs-number">63</span>,<span class="hljs-number">200</span>,<span class="hljs-number">363</span>,<span class="hljs-number">242</span>,<span class="hljs-string">"Colchester"</span>
<span class="hljs-number">71</span>,<span class="hljs-number">271</span>,<span class="hljs-number">383</span>,<span class="hljs-number">313</span>,<span class="hljs-string">"Greenstead"</span></code></pre>

<p>ground truth 文件格式为：<span class="MathJax_Preview"></span><span class="MathJax" id="MathJax-Element-1-Frame" role="textbox" aria-readonly="true" style=""><nobr><span class="math" id="MathJax-Span-1" style="width: 14.083em; display: inline-block;"><span style="display: inline-block; position: relative; width: 11.256em; height: 0px; font-size: 125%;"><span style="position: absolute; clip: rect(1.709em 1000em 2.989em -0.531em); top: -2.557em; left: 0.003em;"><span class="mrow" id="MathJax-Span-2"><span class="msubsup" id="MathJax-Span-3"><span style="display: inline-block; position: relative; width: 1.549em; height: 0px;"><span style="position: absolute; clip: rect(1.976em 1000em 2.723em -0.531em); top: -2.557em; left: 0.003em;"><span class="mi" id="MathJax-Span-4" style="font-family: STIXGeneral-Italic;">x<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span style="display: inline-block; width: 0px; height: 2.563em;"></span></span><span style="position: absolute; top: -2.237em; left: 0.429em;"><span class="texatom" id="MathJax-Span-5"><span class="mrow" id="MathJax-Span-6"><span class="mi" id="MathJax-Span-7" style="font-size: 70.7%; font-family: STIXGeneral-Italic;">m</span><span class="mi" id="MathJax-Span-8" style="font-size: 70.7%; font-family: STIXGeneral-Italic;">i</span><span class="mi" id="MathJax-Span-9" style="font-size: 70.7%; font-family: STIXGeneral-Italic;">n</span></span></span><span style="display: inline-block; width: 0px; height: 2.403em;"></span></span></span></span><span class="mo" id="MathJax-Span-10" style="font-family: STIXGeneral-Regular;">,</span><span class="mtext" id="MathJax-Span-11" style="font-family: STIXGeneral-Regular; padding-left: 0.216em;">&nbsp;</span><span class="msubsup" id="MathJax-Span-12"><span style="display: inline-block; position: relative; width: 1.549em; height: 0px;"><span style="position: absolute; clip: rect(1.976em 1000em 2.936em -0.477em); top: -2.557em; left: 0.003em;"><span class="mi" id="MathJax-Span-13" style="font-family: STIXGeneral-Italic;">y</span><span style="display: inline-block; width: 0px; height: 2.563em;"></span></span><span style="position: absolute; top: -2.131em; left: 0.429em;"><span class="texatom" id="MathJax-Span-14"><span class="mrow" id="MathJax-Span-15"><span class="mi" id="MathJax-Span-16" style="font-size: 70.7%; font-family: STIXGeneral-Italic;">m</span><span class="mi" id="MathJax-Span-17" style="font-size: 70.7%; font-family: STIXGeneral-Italic;">i</span><span class="mi" id="MathJax-Span-18" style="font-size: 70.7%; font-family: STIXGeneral-Italic;">n</span></span></span><span style="display: inline-block; width: 0px; height: 2.403em;"></span></span></span></span><span class="mo" id="MathJax-Span-19" style="font-family: STIXGeneral-Regular;">,</span><span class="mtext" id="MathJax-Span-20" style="font-family: STIXGeneral-Regular; padding-left: 0.216em;">&nbsp;</span><span class="msubsup" id="MathJax-Span-21"><span style="display: inline-block; position: relative; width: 1.656em; height: 0px;"><span style="position: absolute; clip: rect(1.976em 1000em 2.723em -0.531em); top: -2.557em; left: 0.003em;"><span class="mi" id="MathJax-Span-22" style="font-family: STIXGeneral-Italic;">x<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span style="display: inline-block; width: 0px; height: 2.563em;"></span></span><span style="position: absolute; top: -2.237em; left: 0.429em;"><span class="texatom" id="MathJax-Span-23"><span class="mrow" id="MathJax-Span-24"><span class="mi" id="MathJax-Span-25" style="font-size: 70.7%; font-family: STIXGeneral-Italic;">m</span><span class="mi" id="MathJax-Span-26" style="font-size: 70.7%; font-family: STIXGeneral-Italic;">a</span><span class="mi" id="MathJax-Span-27" style="font-size: 70.7%; font-family: STIXGeneral-Italic;">x<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.403em;"></span></span></span></span><span class="mo" id="MathJax-Span-28" style="font-family: STIXGeneral-Regular;">,</span><span class="mtext" id="MathJax-Span-29" style="font-family: STIXGeneral-Regular; padding-left: 0.216em;">&nbsp;</span><span class="msubsup" id="MathJax-Span-30"><span style="display: inline-block; position: relative; width: 1.656em; height: 0px;"><span style="position: absolute; clip: rect(1.976em 1000em 2.936em -0.477em); top: -2.557em; left: 0.003em;"><span class="mi" id="MathJax-Span-31" style="font-family: STIXGeneral-Italic;">y</span><span style="display: inline-block; width: 0px; height: 2.563em;"></span></span><span style="position: absolute; top: -2.131em; left: 0.429em;"><span class="texatom" id="MathJax-Span-32"><span class="mrow" id="MathJax-Span-33"><span class="mi" id="MathJax-Span-34" style="font-size: 70.7%; font-family: STIXGeneral-Italic;">m</span><span class="mi" id="MathJax-Span-35" style="font-size: 70.7%; font-family: STIXGeneral-Italic;">a</span><span class="mi" id="MathJax-Span-36" style="font-size: 70.7%; font-family: STIXGeneral-Italic;">x<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.403em;"></span></span></span></span><span class="mo" id="MathJax-Span-37" style="font-family: STIXGeneral-Regular;">,</span><span class="mtext" id="MathJax-Span-38" style="font-family: STIXGeneral-Regular; padding-left: 0.216em;">&nbsp;</span><span class="mi" id="MathJax-Span-39" style="font-family: STIXGeneral-Italic;">l<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mi" id="MathJax-Span-40" style="font-family: STIXGeneral-Italic;">a</span><span class="mi" id="MathJax-Span-41" style="font-family: STIXGeneral-Italic;">b</span><span class="mi" id="MathJax-Span-42" style="font-family: STIXGeneral-Italic;">e</span><span class="mi" id="MathJax-Span-43" style="font-family: STIXGeneral-Italic;">l<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.563em;"></span></span></span><span style="border-left: 0.003em solid; display: inline-block; overflow: hidden; width: 0px; height: 1.27em; vertical-align: -0.397em;"></span></span></nobr></span><script type="math/tex" id="MathJax-Element-1">x_{min},\  y_{min},\ x_{max},\ y_{max},\ label</script>。同时，要注意，这里的坐标系是如下摆放： <br>
</p><center><img src="http://img.blog.csdn.net/20161018193558255" height="150"></center><p></p>

<p>将 ground truth 的 txt 文件转换为 Pascal VOC 的 XML 格式的代码如下：</p>



<pre class="prettyprint"><code class="language-python hljs "><span class="hljs-comment">#! /usr/bin/python</span>

<span class="hljs-keyword">import</span> os, sys
<span class="hljs-keyword">import</span> glob
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image

<span class="hljs-comment"># ICDAR 图像存储位置</span>
src_img_dir = <span class="hljs-string">"/media/chenxp/Datadisk/ocr_dataset/ICDAR2011/train-textloc"</span>
<span class="hljs-comment"># ICDAR 图像的 ground truth 的 txt 文件存放位置</span>
src_txt_dir = <span class="hljs-string">"/media/chenxp/Datadisk/ocr_dataset/ICDAR2011/train-textloc"</span>

img_Lists = glob.glob(src_img_dir + <span class="hljs-string">'/*.jpg'</span>)

img_basenames = [] <span class="hljs-comment"># e.g. 100.jpg</span>
<span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> img_Lists:
    img_basenames.append(os.path.basename(item))

img_names = [] <span class="hljs-comment"># e.g. 100</span>
<span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> img_basenames:
    temp1, temp2 = os.path.splitext(item)
    img_names.append(temp1)

<span class="hljs-keyword">for</span> img <span class="hljs-keyword">in</span> img_names:
    im = Image.open((src_img_dir + <span class="hljs-string">'/'</span> + img + <span class="hljs-string">'.jpg'</span>))
    width, height = im.size

    <span class="hljs-comment"># open the crospronding txt file</span>
    gt = open(src_txt_dir + <span class="hljs-string">'/gt_'</span> + img + <span class="hljs-string">'.txt'</span>).read().splitlines()

    <span class="hljs-comment"># write in xml file</span>
    os.mknod(src_txt_dir + <span class="hljs-string">'/'</span> + img + <span class="hljs-string">'.xml'</span>)
    xml_file = open((src_txt_dir + <span class="hljs-string">'/'</span> + img + <span class="hljs-string">'.xml'</span>), <span class="hljs-string">'w'</span>)
    xml_file.write(<span class="hljs-string">'&lt;annotation&gt;\n'</span>)
    xml_file.write(<span class="hljs-string">'    &lt;folder&gt;VOC2007&lt;/folder&gt;\n'</span>)
    xml_file.write(<span class="hljs-string">'    &lt;filename&gt;'</span> + str(img) + <span class="hljs-string">'.jpg'</span> + <span class="hljs-string">'&lt;/filename&gt;\n'</span>)
    xml_file.write(<span class="hljs-string">'    &lt;size&gt;\n'</span>)
    xml_file.write(<span class="hljs-string">'        &lt;width&gt;'</span> + str(width) + <span class="hljs-string">'&lt;/width&gt;\n'</span>)
    xml_file.write(<span class="hljs-string">'        &lt;height&gt;'</span> + str(height) + <span class="hljs-string">'&lt;/height&gt;\n'</span>)
    xml_file.write(<span class="hljs-string">'        &lt;depth&gt;3&lt;/depth&gt;\n'</span>)
    xml_file.write(<span class="hljs-string">'    &lt;/size&gt;\n'</span>)

    <span class="hljs-comment"># write the region of text on xml file</span>
    <span class="hljs-keyword">for</span> img_each_label <span class="hljs-keyword">in</span> gt:
        spt = img_each_label.split(<span class="hljs-string">','</span>)
        xml_file.write(<span class="hljs-string">'    &lt;object&gt;\n'</span>)
        xml_file.write(<span class="hljs-string">'        &lt;name&gt;text&lt;/name&gt;\n'</span>)
        xml_file.write(<span class="hljs-string">'        &lt;pose&gt;Unspecified&lt;/pose&gt;\n'</span>)
        xml_file.write(<span class="hljs-string">'        &lt;truncated&gt;0&lt;/truncated&gt;\n'</span>)
        xml_file.write(<span class="hljs-string">'        &lt;difficult&gt;0&lt;/difficult&gt;\n'</span>)
        xml_file.write(<span class="hljs-string">'        &lt;bndbox&gt;\n'</span>)
        xml_file.write(<span class="hljs-string">'            &lt;xmin&gt;'</span> + str(spt[<span class="hljs-number">0</span>]) + <span class="hljs-string">'&lt;/xmin&gt;\n'</span>)
        xml_file.write(<span class="hljs-string">'            &lt;ymin&gt;'</span> + str(spt[<span class="hljs-number">1</span>]) + <span class="hljs-string">'&lt;/ymin&gt;\n'</span>)
        xml_file.write(<span class="hljs-string">'            &lt;xmax&gt;'</span> + str(spt[<span class="hljs-number">2</span>]) + <span class="hljs-string">'&lt;/xmax&gt;\n'</span>)
        xml_file.write(<span class="hljs-string">'            &lt;ymax&gt;'</span> + str(spt[<span class="hljs-number">3</span>]) + <span class="hljs-string">'&lt;/ymax&gt;\n'</span>)
        xml_file.write(<span class="hljs-string">'        &lt;/bndbox&gt;\n'</span>)
        xml_file.write(<span class="hljs-string">'    &lt;/object&gt;\n'</span>)

    xml_file.write(<span class="hljs-string">'&lt;/annotation&gt;'</span>)</code></pre>

<p>x上面代码运行结果是得到如下的 XML 文件，同样用上面的 <code>100.jpg</code> 图像示例，其转换结果如下：</p>



<pre class="prettyprint"><code class="language-xml hljs "><span class="hljs-tag">&lt;<span class="hljs-title">annotation</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">folder</span>&gt;</span>VOC2007<span class="hljs-tag">&lt;/<span class="hljs-title">folder</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">filename</span>&gt;</span>100.jpg<span class="hljs-tag">&lt;/<span class="hljs-title">filename</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">size</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">width</span>&gt;</span>640<span class="hljs-tag">&lt;/<span class="hljs-title">width</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">height</span>&gt;</span>480<span class="hljs-tag">&lt;/<span class="hljs-title">height</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">depth</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-title">depth</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">size</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">object</span>&gt;</span>
    ......
<span class="hljs-tag">&lt;/<span class="hljs-title">annotation</span>&gt;</span></code></pre>

<p>上面代码生成的 XML 文件，与图像文件存储在一个地方。</p>



<h3 id="生成训练图像与-xml-标签的位置文件">生成训练图像与 XML 标签的位置文件</h3>

<p>这一步，按照 SSD 训练的需求，将图像位置，及其对应的 XML 文件位置写入一个 txt 文件，供训练时读取，一个文件名称叫做：<code>trainval.txt</code> 文件，另一个叫做：<code>test.txt</code> 文件。形式如下：</p>



<pre class="prettyprint"><code class=" hljs lasso">scenetext/JPEGImages/<span class="hljs-number">106.</span>jpg scenetext/Annotations/<span class="hljs-number">106.</span><span class="hljs-built_in">xml</span>
scenetext/JPEGImages/<span class="hljs-number">203.</span>jpg scenetext/Annotations/<span class="hljs-number">203.</span><span class="hljs-built_in">xml</span>
scenetext/JPEGImages/<span class="hljs-number">258.</span>jpg scenetext/Annotations/<span class="hljs-number">258.</span><span class="hljs-built_in">xml</span>
scenetext/JPEGImages/<span class="hljs-number">122.</span>jpg scenetext/Annotations/<span class="hljs-number">122.</span><span class="hljs-built_in">xml</span>
scenetext/JPEGImages/<span class="hljs-number">103.</span>jpg scenetext/Annotations/<span class="hljs-number">103.</span><span class="hljs-built_in">xml</span>
scenetext/JPEGImages/<span class="hljs-number">213.</span>jpg scenetext/Annotations/<span class="hljs-number">213.</span><span class="hljs-built_in">xml</span>
scenetext/JPEGImages/<span class="hljs-number">149.</span>jpg scenetext/Annotations/<span class="hljs-number">149.</span><span class="hljs-built_in">xml</span>
<span class="hljs-attribute">...</span><span class="hljs-attribute">...</span></code></pre>

<p>生成的代码如下：</p>



<pre class="prettyprint"><code class="language-python hljs "><span class="hljs-comment">#! /usr/bin/python</span>

<span class="hljs-keyword">import</span> os, sys
<span class="hljs-keyword">import</span> glob

trainval_dir = <span class="hljs-string">"/home/chenxp/data/VOCdevkit/scenetext/trainval"</span>
test_dir = <span class="hljs-string">"/home/chenxp/data/VOCdevkit/scenetext/test"</span>

trainval_img_lists = glob.glob(trainval_dir + <span class="hljs-string">'/*.jpg'</span>)
trainval_img_names = []
<span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> trainval_img_lists:
    temp1, temp2 = os.path.splitext(os.path.basename(item))
    trainval_img_names.append(temp1)

test_img_lists = glob.glob(test_dir + <span class="hljs-string">'/*.jpg'</span>)
test_img_names = []
<span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> test_img_lists:
    temp1, temp2 = os.path.splitext(os.path.basename(item))
    test_img_names.append(temp1)

dist_img_dir = <span class="hljs-string">"scenetext/JPEGImages"</span>
dist_anno_dir = <span class="hljs-string">"scenetext/Annotations"</span>

trainval_fd = open(<span class="hljs-string">"/home/chenxp/caffe/data/scenetext/trainval.txt"</span>, <span class="hljs-string">'w'</span>)
test_fd = open(<span class="hljs-string">"/home/chenxp/caffe/data/scenetext/test.txt"</span>, <span class="hljs-string">'w'</span>)

<span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> trainval_img_names:
    trainval_fd.write(dist_img_dir + <span class="hljs-string">'/'</span> + str(item) + <span class="hljs-string">'.jpg'</span> + <span class="hljs-string">' '</span> + dist_anno_dir + <span class="hljs-string">'/'</span> + str(item) + <span class="hljs-string">'.xml\n'</span>)

<span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> test_img_names:
    test_fd.write(dist_img_dir + <span class="hljs-string">'/'</span> + str(item) + <span class="hljs-string">'.jpg'</span> + <span class="hljs-string">' '</span> + dist_anno_dir + <span class="hljs-string">'/'</span> + str(item) + <span class="hljs-string">'.xml\n'</span>)</code></pre>



<h3 id="生成-test-name-size-文本文件">生成 test name size 文本文件</h3>

<p>这一步，SSD 还需要一个名叫：<code>test_name_size.txt</code> 的文件，里面记录训练图像、测试图像的图像名称、height、width。内容形式如下：</p>



<pre class="prettyprint"><code class=" hljs lasso"><span class="hljs-number">106</span> <span class="hljs-number">480</span> <span class="hljs-number">640</span>
<span class="hljs-number">203</span> <span class="hljs-number">480</span> <span class="hljs-number">640</span>
<span class="hljs-number">258</span> <span class="hljs-number">480</span> <span class="hljs-number">640</span>
<span class="hljs-number">318</span> <span class="hljs-number">480</span> <span class="hljs-number">640</span>
<span class="hljs-number">122</span> <span class="hljs-number">480</span> <span class="hljs-number">640</span>
<span class="hljs-number">103</span> <span class="hljs-number">480</span> <span class="hljs-number">640</span>
<span class="hljs-number">320</span> <span class="hljs-number">640</span> <span class="hljs-number">480</span>
<span class="hljs-attribute">...</span><span class="hljs-attribute">...</span></code></pre>

<p>生成这个文本文件的代码如下：</p>



<pre class="prettyprint"><code class="language-python hljs "><span class="hljs-comment">#! /usr/bin/python</span>

<span class="hljs-keyword">import</span> os, sys
<span class="hljs-keyword">import</span> glob
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image

img_dir = <span class="hljs-string">"/home/chenxp/data/VOCdevkit/scenetext/JPEGImages"</span>

img_lists = glob.glob(img_dir + <span class="hljs-string">'/*.jpg'</span>)

test_name_size = open(<span class="hljs-string">'/home/chenxp/caffe/data/scenetext/test_name_size.txt'</span>, <span class="hljs-string">'w'</span>)

<span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> img_lists:
    img = Image.open(item)
    width, height = img.size
    temp1, temp2 = os.path.splitext(os.path.basename(item))
    test_name_size.write(temp1 + <span class="hljs-string">' '</span> + str(height) + <span class="hljs-string">' '</span> + str(width) + <span class="hljs-string">'\n'</span>)</code></pre>



<h3 id="准备标签映射文件-labelmap">准备标签映射文件 labelmap</h3>

<p>这个 <code>prototxt</code> 文件是记录 label 与 name 之间的对应关系的，内容如下：</p>



<pre class="prettyprint"><code class="language-prototxt hljs css"><span class="hljs-tag">item</span> <span class="hljs-rules">{
  <span class="hljs-rule"><span class="hljs-attribute">name</span>:<span class="hljs-value"> <span class="hljs-string">"none_of_the_above"</span>
  label: <span class="hljs-number">0</span>
  display_name: <span class="hljs-string">"background"</span>
</span></span></span>}
<span class="hljs-tag">item</span> <span class="hljs-rules">{
  <span class="hljs-rule"><span class="hljs-attribute">name</span>:<span class="hljs-value"> <span class="hljs-string">"object"</span>
  label: <span class="hljs-number">1</span>
  display_name: <span class="hljs-string">"text"</span>
</span></span></span>}</code></pre>

<p>我的 <code>prototxt</code> 文件名称，被我重命名为：<code>labelmap_voc.prototxt</code></p>

<p><br></p>



<h2 id="生成-lmdb-数据库">生成 lmdb 数据库</h2>

<p>准备好上述的几个文本文件，将其放置在如下位置：</p>



<pre class="prettyprint"><code class="language-bash hljs ">/home/chenxp/caffe/data/scenetext</code></pre>

<p>这时候，需要修改调用 SSD 源码中提供的 <code>create_data.sh</code> 脚本文件（我将文件重命名为：<code>create_data_scenetext.sh</code>）：</p>



<pre class="prettyprint"><code class="language-bash hljs ">cur_dir=$(<span class="hljs-built_in">cd</span> $( dirname <span class="hljs-variable">${BASH_SOURCE[0]}</span> ) &amp;&amp; <span class="hljs-built_in">pwd</span> )
root_dir=<span class="hljs-variable">$cur_dir</span>/../..

<span class="hljs-built_in">cd</span> <span class="hljs-variable">$root_dir</span>

redo=<span class="hljs-number">1</span>
data_root_dir=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/data/VOCdevkit"</span>
dataset_name=<span class="hljs-string">"scenetext"</span>
mapfile=<span class="hljs-string">"<span class="hljs-variable">$root_dir</span>/data/<span class="hljs-variable">$dataset_name</span>/labelmap_voc_scenetext.prototxt"</span>
anno_<span class="hljs-built_in">type</span>=<span class="hljs-string">"detection"</span>
db=<span class="hljs-string">"lmdb"</span>
min_dim=<span class="hljs-number">0</span>
max_dim=<span class="hljs-number">0</span>
width=<span class="hljs-number">0</span>
height=<span class="hljs-number">0</span>

extra_cmd=<span class="hljs-string">"--encode-type=jpg --encoded"</span>
<span class="hljs-keyword">if</span> [ <span class="hljs-variable">$redo</span> ]
<span class="hljs-keyword">then</span>
  extra_cmd=<span class="hljs-string">"<span class="hljs-variable">$extra_cmd</span> --redo"</span>
<span class="hljs-keyword">fi</span>
<span class="hljs-keyword">for</span> subset <span class="hljs-keyword">in</span> test trainval
<span class="hljs-keyword">do</span>
  python <span class="hljs-variable">$root_dir</span>/scripts/create_annoset.py --anno-type=<span class="hljs-variable">$anno_type</span> --label-map-file=<span class="hljs-variable">$mapfile</span> \
  --min-dim=<span class="hljs-variable">$min_dim</span> --max-dim=<span class="hljs-variable">$max_dim</span> --resize-width=<span class="hljs-variable">$width</span> --resize-height=<span class="hljs-variable">$height</span> \
  --check-label <span class="hljs-variable">$extra_cmd</span> <span class="hljs-variable">$data_root_dir</span> <span class="hljs-variable">$root_dir</span>/data/<span class="hljs-variable">$dataset_name</span>/<span class="hljs-variable">$subset</span>.txt \
  <span class="hljs-variable">$data_root_dir</span>/<span class="hljs-variable">$dataset_name</span>/<span class="hljs-variable">$db</span>/<span class="hljs-variable">$dataset_name</span><span class="hljs-string">"_"</span><span class="hljs-variable">$subset</span><span class="hljs-string">"_"</span><span class="hljs-variable">$db</span> examples/<span class="hljs-variable">$dataset_name</span>
<span class="hljs-keyword">done</span></code></pre>

<p>上面的 <code>bash</code> 脚本会自动将训练的 ICDAR 2011 的图像文件与对应 label 转换为 lmdb 文件。转换后的文件位置可参见上面脚本的内容，我的位置为：</p>



<pre class="prettyprint"><code class="language-bash hljs ">/home/chenxp/caffe/examples/scenetext_trainval_lmdb
/home/chenxp/caffe/examples/scenetext_test_lmdb</code></pre>

<p><br></p>



<h2 id="训练模型">训练模型</h2>

<p>将 SSD 用于自己的检测任务，是需要 <a href="http://nbviewer.jupyter.org/github/BVLC/caffe/blob/master/examples/02-fine-tuning.ipynb">Fine-tuning a pretrained network</a> 的。</p>

<p>具体的，需要加载 SSD 作者提供的 <a href="https://gist.github.com/weiliu89/2ed6e13bfd5b57cf81d6">VGG_ILSVRC_16_layers_fc_reduced.caffemodel</a>，在这个预训练的模型上，继续用我们的数据训练。</p>

<p>下载下来后，放在如下位置下面：</p>



<pre class="prettyprint"><code class="language-bash hljs ">/home/chenxp/caffe/models/VGGNet</code></pre>

<p>之后，修改作者提供的训练 Python 代码：<code>ssd_pascal.py</code>，这份代码会自动创建训练所需要的如下几个文件：</p>

<ul>
<li>deploy.prototxt</li>
<li>solver.prototxt</li>
<li>trainval.prototxt</li>
<li>test.prototxt</li>
</ul>

<p>我们需要按照自己的情况，修改如下几处地方：</p>



<pre class="prettyprint"><code class="language-python hljs "><span class="hljs-comment"># Modify the job name if you want.</span>
job_name = <span class="hljs-string">"SSD_{}"</span>.format(resize)
<span class="hljs-comment"># The name of the model. Modify it if you want.</span>
model_name = <span class="hljs-string">"VGG_VOC0712_{}"</span>.format(job_name)

<span class="hljs-comment"># Directory which stores the model .prototxt file.</span>
save_dir = <span class="hljs-string">"models/VGGNet/VOC0712/{}"</span>.format(job_name)
<span class="hljs-comment"># Directory which stores the snapshot of models.</span>
snapshot_dir = <span class="hljs-string">"models/VGGNet/VOC0712/{}"</span>.format(job_name)
<span class="hljs-comment"># Directory which stores the job script and log file.</span>
job_dir = <span class="hljs-string">"jobs/VGGNet/VOC0712/{}"</span>.format(job_name)
<span class="hljs-comment"># Directory which stores the detection results.</span>
output_result_dir = <span class="hljs-string">"{}/data/VOCdevkit/results/VOC2007/{}/Main"</span>.format(os.environ[<span class="hljs-string">'HOME'</span>], job_name)

<span class="hljs-comment"># model definition files.</span>
train_net_file = <span class="hljs-string">"{}/train.prototxt"</span>.format(save_dir)
test_net_file = <span class="hljs-string">"{}/test.prototxt"</span>.format(save_dir)
deploy_net_file = <span class="hljs-string">"{}/deploy.prototxt"</span>.format(save_dir)
solver_file = <span class="hljs-string">"{}/solver.prototxt"</span>.format(save_dir)
<span class="hljs-comment"># snapshot prefix.</span>
snapshot_prefix = <span class="hljs-string">"{}/{}"</span>.format(snapshot_dir, model_name)
<span class="hljs-comment"># job script path.</span>
job_file = <span class="hljs-string">"{}/{}.sh"</span>.format(job_dir, model_name)

<span class="hljs-comment"># Stores the test image names and sizes. Created by data/VOC0712/create_list.sh</span>
name_size_file = <span class="hljs-string">"data/VOC0712/test_name_size.txt"</span>
<span class="hljs-comment"># The pretrained model. We use the Fully convolutional reduced (atrous) VGGNet.</span>
pretrain_model = <span class="hljs-string">"models/VGGNet/VGG_ILSVRC_16_layers_fc_reduced.caffemodel"</span>
<span class="hljs-comment"># Stores LabelMapItem.</span>
label_map_file = <span class="hljs-string">"data/VOC0712/labelmap_voc.prototxt"</span>

num_classes = <span class="hljs-number">21</span>

num_test_image = <span class="hljs-number">4952</span></code></pre>

<p><br></p>



<h2 id="我的训练参数">我的训练参数</h2>

<p>其实还需要修改一些，如训练时的参数。因为一开始若直接用作者 <code>ssd_pascal.py</code> 文件中的默认的 <code>solver.prototxt</code> 参数，会出现如下情况： <br>
</p><center><img src="http://img.blog.csdn.net/20161018203104205" alt="这里写图片描述" title=""></center><p></p>

<p>跑着跑着，loss 就变成 <code>nan</code> 了，发散了，不收敛。</p>

<p>我调试了一段时间，我的 <code>solver.prototxt</code> 参数设置如下，可保证收敛：</p>



<pre class="prettyprint"><code class="language-prototxt hljs http"><span class="hljs-attribute">base_lr</span>: <span class="hljs-string">0.0001</span></code></pre>

<p>其余参数可看自己设置。学习率一定要小，原先的 0.001 就会发散。</p>

<p>训练结束： <br>
</p><center><img src="http://img.blog.csdn.net/20161018203612555" alt="这里写图片描述" title=""></center><p></p>

<p>可以看见，最后的测试精度为 0.776573，感觉 SSD 效果还可以。</p>

<p>我自己训练好的模型，上传到云端了：链接：<a href="http://share.weiyun.com/1c544de66be06ea04774fd11e820a780">http://share.weiyun.com/1c544de66be06ea04774fd11e820a780</a> （密码：ERid5Y）</p>

<p>这个需要在下一阶段的测试中用到。</p>

<p><br></p>



<h2 id="用训练好的-model-进行-predict">用训练好的 model 进行 predict</h2>

<p>SSD 的作者也给我们写好了 predict 的代码，我们只需要该参数就可以了。</p>

<p>用 jupyter notebook 打开 <code>~/caffe/examples/ssd_detect.ipynb</code> 文件，这是作者为我们写好的将训练好的 <code>caffemodel</code> 用于检测的文件。</p>

<p>指定好 <code>caffemodel</code>，<code>deploy.txt</code>，详细的看我上传的代码吧。</p>

<p>测试几张图像，结果如下： <br>
</p><center><img src="http://img.blog.csdn.net/20161018211826705" alt="这里写图片描述" title=""></center> <br>
<center><img src="http://img.blog.csdn.net/20161018211839350" alt="这里写图片描述" title=""></center> <br>
<center><img src="http://img.blog.csdn.net/20161018211856257" alt="这里写图片描述" title=""></center><p></p>

<p><br></p>



<h2 id="参考">参考</h2>

<ol>
<li><a href="http://arxiv.org/abs/1512.02325">ECCV2016 Paper: 《SSD: Single Shot MultiBox Detector》</a></li>
<li><a href="https://github.com/weiliu89/caffe/tree/ssd">SSD 源代码</a></li>
<li><a href="https://github.com/hyh21521038/ssd-plate_detection">SSD-plate_detection from solace_hyh</a></li>
<li><a href="http://www.cnblogs.com/objectDetect/p/5780006.html">SSD框架训练自己的数据集</a> </li>
</ol></div></body>
</html>